---
title: "Big Problems for \\color{USCCardinal} Small Networks\\color{black}: Statistical Analysis of Small Networks and Team Performance"
author:
  - "\\textbf{George G Vega Yon}"
  - "Kayla de la Haye \\vspace{-.5cm}"
date: "SONIC Speaker Series\\linebreak[4]Northwestern University, IL\\linebreak[4]March 20, 2019"
institute:
  - "\\includegraphics[width=.15\\linewidth]{usc.pdf}\\linebreak[4]Department of Preventive Medicine"
output:
  beamer_presentation:
    keep_tex: true
    includes:
      in_header: ergmitos-header.tex
# classoption: handout
fontsize: 10pt
aspectratio: 169
bibliography: bibliography.bib
---

```{r setup, include=FALSE}
knitr::knit_hooks$set(smallsize = function(before, options, envir) {
    if (before) {
        "\\footnotesize\n\n"
    } else {
        "\n\\normalsize\n\n"
    }
})
knitr::opts_chunk$set(echo = TRUE, smallsize=TRUE)
```

## Contents

\tableofcontents

## Acknowledgements

\begincols
\begincol{.15\linewidth}

\includegraphics[width=.8\linewidth]{ARO_logo.png}

\endcol

\begincol{.84\linewidth}
This material is based upon work support by, or in part by, the U.S. Army Research
Laboratory and the U.S. Army Research Office under grant number W911NF-15-1-0577
\endcol

\endcols


\begincols
\begincol{.84\linewidth}

Computation for the work described in this paper was supported by the University
of Southern California’s Center for High-Performance Computing (https://hpcc.usc.edu).
\endcol

\begincol{.15\linewidth}
\includegraphics[width = 1\linewidth]{usc.pdf}
\endcol
\endcols

We thank members of our MURI research team, USC's Center for Applied Network Analysis, Andrew Slaughter, and attendees of the NASN 2018 conference for their comments.


\begin{figure}
\centering
\includegraphics[width=1\linewidth]{muriteams.png}
\end{figure}


# Part I: Exponential Random Graph Models for Small Networks

## Exponential Random Graph Models (ERGMs)

\begin{figure}
\centering
\includegraphics[height=.7\textheight]{ukfaculty-igraph.png}
\caption{Friendship network of a UK university faculty. Source: \textbf{igraphdata} R package (Gabor Csardi, 2015). Figure drawn using the R package \textbf{netplot} ( (https://github.com/usccana/netplot)}
\end{figure}\pause

\large How can we explain what we see here? \normalsize

## ERGMs... the \textit{lingua franca} of SNA

- Seeks to answer the question: \emph{What local social structures gave origin to a given observed graph?}\pause

- The model is centered around a vector of \textbf{sufficient statistics} $\sufstats{}$, and is operationalized as:
  
  \begin{equation}
  	\Prcond{\Graph = \graph}{\params, \Indepvar} = \frac{%
  		\exp{\transpose{\params}\sufstats{\graph, \Indepvar}}%	
  	}{
  		\kappa\left(\params, \Indepvar\right)
  	},\quad\forall \graph\in\GRAPH\label{eq:ergm}
  \end{equation}
  
  Where $\kappa\left(\params, \Indepvar\right)$ is the normalizing constant and equals $\sum_{\graph'\in\GRAPH}\exp{\transpose{\params}\sufstats{\graph', \Indepvar}}$. Figure \autoref{fig:ergm-structs} shows some examples of values in $\sufstats{}$.\pause
  
- In the case of directed networks, $\GRAPH$ has $2^{n(n-1)}$, terms.\pause

- See Wasserman, Pattison, Robins, Snijders, Handcock and others.


## Structures

\def\fig1width{.45\linewidth}
\begin{figure}
\centering
\begin{tabular}{m{.2\linewidth}<\centering m{.4\linewidth}<\raggedright}
\toprule Representation & Description  \\ \midrule
\includegraphics[width=\fig1width]{terms/mutual.pdf} & Mutual Ties (Reciprocity)\linebreak[4]$\sum_{i\neq j}y_{ij}y_{ji}$  \\
\includegraphics[width=\fig1width]{terms/ttriad.pdf} & Transitive Triad (Balance)\linebreak[4]$\sum_{i\neq j\neq k}y_{ij}y_{jk}y_{ik}$  \\
\includegraphics[width=\fig1width]{terms/homophily.pdf} & Homophily\linebreak[4]$\sum_{i\neq j}y_{ij}\mathbf{1}\left(x_i=x_j\right)$ \\
\includegraphics[width=\fig1width]{terms/nodeicov.pdf} & Covariate Effect for Incoming Ties\linebreak[4]$\sum_{i\neq j}y_{ij}x_j$ \\
\includegraphics[width=\fig1width]{terms/fourcycle.pdf} & Four Cycle\linebreak[4]$\sum_{i\neq j \neq k \neq l}y_{ij}y_{jk}y_{kl}y_{li}$  \\
\bottomrule
\end{tabular}
\caption{\label{fig:ergm-structs}Besides of the common edge count statistic (number of ties in a graph), ERGMs allow measuring other more complex structures that can be captured as sufficient statistics. }
\end{figure}

---

\large \textbf{Example of model} \normalsize


\begincols

\begincol{.4\linewidth}

In this network\linebreak

```{r simple-model, echo=FALSE, cache=TRUE, fig.align='center', fig.width=8, fig.height=5, out.width='.9\\linewidth', warning=FALSE, message=FALSE}
set.seed(13)
# x <- ergmito::rbernoulli(4)
x <- structure(c(0, 1, 1, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0), .Dim = c(4L, 
4L))
library(sna)
gplot(x, vertex.col = rgb(153, 0, 0, maxColorValue = 255))
```

\pause

We see 4 **edges**, 1 **transitive triad** and **no mutual ties**.

\endcol

\pause

\begincol{.4\linewidth}

The probability function of this model would be

\footnotesize

\begin{equation*}
\Prcond{\Graph = \graph}{\theta} = \frac{\exp{4\theta_{edges} + \theta_{ttriads} \textcolor{lightgray}{+ 0\theta_{mutual}}}}{%
\sum_{\graph'\in\GRAPH} \exp{\transpose{\theta} \sufstats{\graph'}}}
\end{equation*}

\normalsize

\noindent with $\theta = \transpose{[\theta_{edges}\quad \theta_{ttriads} \quad \theta_{mutual}]}$

\endcol

\endcols

```{r simple-model-estimates, cache=TRUE, echo=FALSE}
estimates0 <- ergmito::ergmito(x ~ edges + ttriad + mutual)
estimates0_coefs <- sprintf("%03.2f", coef(estimates0))
```

\pause

\vspace{1cm}

This model has **MLE parameter estimates** of `r estimates0_coefs[1]` (low density), `r estimates0_coefs[2]` (high chance of ttriads), and `r estimates0_coefs[3]` (low chance of mutuality) for the parameters `edges`, `ttriads`, and `mutual` respectively.

## Estimation of ERGMs


- Calculating of the normalizing constant in \eqref{eq:ergm}, $\kappa = \sum_{\graph'\in\GRAPH}\exp{\transpose{\params}\sufstats{\graph', \Indepvar}}$, makes ERGMs difficult to estimate.\pause

- For this reason, statistical methods have focused on avoiding the direct calculation of $\kappa$; most modern methods for estimating ERGMs rely on MCMC.


## Estimation of ERGMs (cont'd) {.t}

Description of the MCMC-MLE algorithm (one of the approaches)

1.  Make an initial guess of the model parameters using MPL (maximum pseudo likelihood), $\hat\theta_0$

2.  While the algorithm doesn't converge, do:
    
    a.  Generate a large sample of graphs from $\Prcond{\Graph = \graph}{\hat\theta_0, \Indepvar}$ using MCMC
    
    b.  Use the simulated sample of graphs to approximate the likelihood function. And with this approximation update the parameter $\theta_0$ using a Newton-Raphson step.
    
    c.  next iteration\pause
    
    Once it coverges, the last value of $\hat\theta_0$ is the MCMC-MLE estimates.\pause The variance approximation is another story.
    

---

- While significant advances have been made in the area, simulation based models can suffer from \textbf{model degeneracy}.\pause

- Model degeneracy is particularly problematic with small networks.

\begin{figure}
\centering
\caption{Model generacy. Figure}
\end{figure}

## ERGMs for Small Networks

\begin{figure}
\centering
\includegraphics[height=.9\textheight]{plot-graph-4-1.pdf}
\end{figure}

## ERGMs for Small Networks (cont'd)
			
- In the case of small networks (e.g. at most 6 nodes), the calculation of $\kappa$ becomes computationally feasible.\pause

- This allows direct calculation of \eqref{eq:ergm}, \textbf{avoiding the need for simulations} and allowing us to obtain Maximum Likelihood Estimates using \textit{standard} optimizations techniques.\pause

- More importantly, in the case that a common data generating process can be assumed, a pooled version of the ERGMs can be estimated.

$$
\Prcond{\Graph_1 = \graph_1, \dots, \Graph_p = \graph_p}{\params, \Indepvar_1, \dots, \Indepvar_p} = \prod_p\frac{%
		\exp{\transpose{\params}\sufstats{\graph_p, \Indepvar_p}}%	
	}{
		\kappa_p\left(\params, \Indepvar_p\right)
	}
$$ 
\pause

How different is this from the "normal" way to fit ERGMs?

## Estimation of ERGM\only<2>{\textcolor{USCCardinal}{ito}}s (cont'd) {.t}

Description of the \textcolor<2->{lightgray}{MCMC-}\textcolor<2->{USCCardinal}{MLE} algorithm (one of the approaches)

1.  Make an initial guess of the model parameters using MPL (maximum pseudo likelihood), $\hat\theta_0$

2.  While the algorithm doesn't converge, do:
    
    a.  \textcolor<2->{lightgray}{Simulate $B$ graphs from $\Prcond{\Graph = \graph}{\hat\theta_0, \Indepvar}$ using MCMC}
    
    b.  \textcolor<2->{lightgray}{Use the simulated sequence of graphs to approximate the likelihood function. And with this approximation} \textcolor<2->{USCCardinal}{update the parameter $\theta_0$ using a Newton-Raphson step}.
    
    c.  next iteration\pause
    
By skiping the MCMC part we:

1.  are able to get MLE estiamates directly,

2.  *avoiding the degeneracy problem* latent in MCMC, and

3.  obtain *more accurate* estimates *faster*. \pause

We have implemented  this and more in the `ergmito` R package

---

An important pause...

\begin{minipage}[c]{1\linewidth}
\large \textbf{ito, ita}: From the latin -\textit{\=ittus}. suffix in spanish used to denote small or affection. e.g.:

\hspace{.5cm} \textit{¡Que lindo ese perr\textcolor{USCCardinal}{\textbf{ito}}!} / \textit{What a beautiful little dog!}

\hspace{.5cm} \textit{¿Me darias una tac\textcolor{USCCardinal}{\textbf{ita}} de azúcar?} / \textit{Would you give me a small cup of sugar?}
\normalsize
\end{minipage}\pause

\alert{Special thanks to George Barnett who proposed the name during the 2018 NASN!}

## Features of `ergmito`



This (\includegraphics[width=.1\linewidth]{lifecycle-experimental-orange.pdf}) R package has the following features\pause

- Built on top of [**statnet**](https://statnet.org)'s [`ergm`](https://github.com/statnet/ergm) R package.\pause

- Allows estimating ERGMs for small networks (less than 7 and perhaps 6)[^whyupto6] via MLE.\pause

- Implements pooled ERGM models.\pause

- In the same spirit of the exhaustive enumeration, includes a simulation function for small networks sampling from the true distribution. 



[^whyupto6]: A directed graph of size 6 has a support set with $2^{6\times(6 - 1)} = 1,073,741,824$ elements.

## `ergmito` example

```{r loading-fivenets}
library(ergmito)
data(fivenets, package = "ergmito")
```

```{r plotfivenets, warning=FALSE, message=FALSE, echo=FALSE, fig.width=6, fig.height=3, out.width='.5\\linewidth', fig.align='center'}
library(sna)
library(network)
op <- par(mfrow = c(2, 3), mai=rep(0, 4), oma = rep(0, 4))
USCCARDINAL <- rgb(153, 0, 0, maxColorValue = 255)
ans <- lapply(fivenets, function(f) {
  gplot(
    f,
    vertex.cex = 2,
    vertex.col = c("white", USCCARDINAL)[
      get.vertex.attribute(f, "female") + 1
    ]
    )
  })
plot.new()
plot.window(xlim = c(0, 1), ylim = c(0, 1))
legend("center", fill = c("white", USCCARDINAL), legend = c("Male", "Female"), cex=1, bty="n")
par(op)
```

----

```{r}
# Looking at one of the five networks
fivenets[[1]]
```

\pause So how can we fit this model?

## `ergmito` example (cont'd)

The same as you would do with the `ergm` package:

```{r fit-fivenets}
(model1 <- ergmito(fivenets ~ edges + nodematch("female")))
```

```{r fit-fivenets-print, results='asis', echo=FALSE}
out <- texreg::texreg(model1)
cat(gsub("#", "\\#", unclass(out), fixed=TRUE))
```




## Simulation Study
			
			
We conducted a simulation study to explore the properties of MLE for small networks (a.k.a. ERGMito). To generate each sample of teams:\pause

1. Draw the **population parameters** from a piecewise Uniform with values in $[-4, -.1]\cup[.1, 4]$\pause

2. We will draw **groups of sizes 3 to 5**. The number of networks per group size are drawn from a Poisson distribution with parameter 10 (hence, an expected size of 30 networks per sample).\pause

3. Use the **drawn parameters** and **group sizes** to **generate random graphs** using an ERGM data generating process.\pause

We simulated 100,000 samples, each one composed of an average of 30 networks.

## Simulation Study (cont'd)

\begin{figure}
\centering
\includegraphics[width=.55\linewidth]{fig/power-02-various-sizes-3-5.pdf}
\caption{Empirical power of Pooled-ERGM estimates at various levels of effect size. As expected, power increases significantly with sample size (\# of networks per sample). Interestingly, the discovery rate of an effect size within $[1, 2)$ is very high even with a sample size of 20-30 networks. More extreme points have higher volatility due to small number of samples included.}
\end{figure}

# Part II: Association between group structure and team performance

## Testing effects of social network structure on group performance
			
Two common approaches: Generalized Linear Models (GLMs), or Mantel-like tests (a.k.a. permutation tests). Both have limitations:\pause
	
- GLMs:\pause
    
    - Sample size is problematic: How costly is getting enough teams to run get a desired level of power?\pause

- Permutation tests:\pause
    
    - Common approach: sample from graphs with the same degree sequence--the observed sequence of in/out degree\pause
      
    - This is oversimplifying/constraining\pause
    
    - And worse, in a network of size 4, how many different networks can be observed **holding the degree sequence fixed**?
  
## An idea

- Lack of power:\pause What if we just simulate them?\pause OK, but aren't we doing this with permutation tests?...

- Sure, but what about ERGMs?\pause Ultimately these models describe a distribution of graphs that have *on average* the same set of network statistics\pause

- This overcomes the problem observed in permutation tests.


## A semiparametric test
			
**Notation**

- $\Graph = \{\graph_j\}$ is a sequence of $J$ graphs that share a common data-generating-process, e.g. teams formed in a lab.

- Each network has node-level attributes $x \in \mathcal{X}$.

- A group(graph) level outcome variable, such as team performance, $Y$.

- Under the null, network structure and group performance are not associated, this is $Y\perp\Graph$.




## Algorithm

1.  Estimate an ERGM (estimates can come from a single graph or pooled estimates). We denote the data-generating-process of this model as $\mathcal{D}: \Theta\times \mathcal{X}\mapsto \GRAPH$.

2.  Calculate the value $s_0 = s(\Graph, Y)$.

3.  Now, for $b \in \{1, \dots, B\}$ do:
    
    1.  For each group $j$ in $\{1, \dots, J\}$, draw a new network $\graph_j^b\sim\mathcal{D}(\hat{\theta}, X_j)$, this new sequence is denoted $\Graph^b$
    
  	2.  Using $\Graph^b$ and $Y$, calculate $s_b = s(\Graph^b, Y)$
  	
  	3.  Next $b$.

This will generate a null distribution for the statistic $s$, which we can use to compare against the observed statistic, $s_0$.

\alert{Note} An important distinction to make is that structures that gave origin to the graph need not to be relevant for the team's performance *per se*.
					
## Illustrated example

Suppose that we have a 3 networks of sizes 4, 4, and 5 respectively. The 

\footnotesize

\def\svgwidth{.8\linewidth}
\begin{figure}
\centering
\input{fig/struct-test.pdf_tex}
\end{figure}

\normalsize

We can use the distribution of the sequence $\{s_1, \dots, s_B\}$ as null to compare against $s_0$

# Part III: An empirical example

## Small teams performance

## Data

## Results

## Concluding remarks

Exponential Random Graph Models for Small Networks:\pause

1.  Not a new thing,\pause what's new is the tool to do so in a smooth way\pause

2.  Still work to do (on the development side of things): Goodness of fit tests, better algorithms for drawing random graphs, bayesian model\pause

3.  Can be extended to other types of ERGMs... our next target: TERGMs (Separable Exponential Random Graph Models)\pause

Test for Association between graph level outcomes and graph structures:\pause

1.  Still need to run simulation studies\pause

2.  Key question 1: What happens when the graph structure is in both the ERGM and the stat\pause

3.  What about other properties such as type I error?



## Thanks!

\begin{centering}
\includegraphics[width = .1\linewidth]{usc.pdf}

\large \textbf{\textcolor{USCCardinal}{George G. Vega Yon}}

\normalsize Let's chat! 

\href{mailto:vegayon@usc.edu}{vegayon@usc.edu} 

\href{https://ggvy.cl}{https://ggvy.cl} 

\includegraphics[width=.02\linewidth]{github.png}\href{https://github.com/gvegayon}{@gvegayon}

\includegraphics[width=.02\linewidth]{twitter.png}\href{https://twitter.com/gvegayon}{@gvegayon}

\end{centering}
